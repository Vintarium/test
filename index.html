<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Приложение для учета занятий</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 800px;
        }
        .input-group {
            margin-bottom: 1rem;
        }
        .input-group label {
            font-weight: 500;
        }
        .input-group input, .input-group textarea, .input-group button {
            border-radius: 0.5rem;
        }
        .btn-primary {
            background-color: #4f46e5;
            color: white;
        }
        .btn-primary:hover {
            background-color: #4338ca;
        }
        .activity-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            margin-bottom: 1rem;
            cursor: pointer;
        }
        .delete-btn {
            background-color: #ef4444;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }
        .delete-btn:hover {
            background-color: #dc2626;
        }
        .file-link {
            color: #4f46e5;
            text-decoration: underline;
        }
        .file-link:hover {
            color: #4338ca;
        }
        .auth-container {
            max-width: 400px;
            margin: 0 auto;
            padding: 2rem;
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            text-align: center;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 0.5rem;
            text-align: center;
        }
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
        }
        .day {
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s ease;
        }
        .day:hover {
            background-color: #e5e7eb;
        }
        .day.selected {
            background-color: #4f46e5;
            color: white;
            font-weight: bold;
        }
        .day.other-month {
            color: #9ca3af;
            background-color: #f3f4f6;
            cursor: not-allowed;
        }
        .day-label {
            font-weight: bold;
            color: #4b5563;
        }
        .day-info {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }
        .day.has-activity {
            background-color: #d1d5db;
        }
        .day.has-activity.selected {
            background-color: #3f35c5;
        }
        .message-box {
            margin-top: 1rem;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-align: center;
        }
        pre.hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Auth Section -->
    <div id="authSection" class="auth-container">
        <h2 id="authTitle" class="text-2xl font-bold mb-4">Вход</h2>
        <div class="input-group">
            <label for="email" class="block text-left text-sm font-medium text-gray-700">Логин</label>
            <input type="text" id="email" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Введите ваш логин">
        </div>
        <div class="input-group">
            <label for="password" class="block text-left text-sm font-medium text-gray-700">Пароль</label>
            <input type="password" id="password" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Введите ваш пароль">
        </div>
        <button id="authBtn" class="w-full mt-4 flex justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Войти</button>
        <p class="text-sm mt-4"><a href="#" id="forgotPasswordLink" class="text-indigo-600 hover:underline">Забыли логин или пароль?</a></p>
        <div id="authMessage" class="hidden mt-4 text-sm font-medium text-center p-2 rounded-md"></div>
    </div>
    
    <!-- Password Reset Section -->
    <div id="passwordResetSection" class="auth-container hidden">
        <h2 class="text-2xl font-bold mb-4">Напоминание</h2>
        <p class="text-gray-600 mb-4">Для входа используйте логин и пароль: <span class="font-bold">admin</span>.</p>
        <p class="text-sm mt-4"><a href="#" id="backToLoginLink" class="text-indigo-600 hover:underline">Вернуться ко входу</a></p>
    </div>

    <!-- Main App Section (hidden initially) -->
    <div id="mainAppSection" class="container mx-auto p-6 bg-white shadow-xl rounded-lg hidden">
        <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
            <h1 class="text-3xl font-bold text-gray-800">Журнал занятий</h1>
            <button id="signOutBtn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Выйти</button>
        </div>
        <p class="text-gray-600 text-center mb-6">Добавляйте свои ежедневные занятия, время и прикрепляйте документы.</p>

        <!-- Calendar Section -->
        <div id="calendarSection">
            <div class="calendar-header">
                <button id="prevMonthBtn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
                </button>
                <span id="currentMonthYear"></span>
                <button id="nextMonthBtn" class="p-2 rounded-full hover:bg-gray-200 focus:outline-none">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
                </button>
            </div>
            <div class="calendar-grid mb-6">
                <div class="day-label">Пн</div>
                <div class="day-label">Вт</div>
                <div class="day-label">Ср</div>
                <div class="day-label">Чт</div>
                <div class="day-label">Пт</div>
                <div class="day-label">Сб</div>
                <div class="day-label">Вс</div>
            </div>
            <div id="calendarDays" class="calendar-grid">
                <!-- Days will be dynamically added here -->
            </div>
        </div>

        <!-- Activity Form Section -->
        <div id="activityFormSection" class="mt-8 hidden">
            <div class="flex flex-col sm:flex-row-reverse sm:justify-between items-center space-y-4 sm:space-y-0 mb-4">
                <button id="returnToCalendarBtn" class="py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400 w-full sm:w-auto">
                    Вернуться к календарю
                </button>
                <h2 class="text-2xl font-bold text-center" id="formTitle">Добавить запись</h2>
            </div>
            <div class="mb-8 p-6 bg-gray-50 rounded-lg border border-gray-200">
                <input type="hidden" id="selectedDateInput">
                <input type="hidden" id="editingDocId">
                <div class="input-group">
                    <label for="activityTime" class="block text-sm font-medium text-gray-700">Время</label>
                    <input type="time" id="activityTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                </div>
                <div class="input-group">
                    <label for="activityDiscipline" class="block text-sm font-medium text-gray-700">Дисциплина</label>
                    <input type="text" id="activityDiscipline" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Например: Математика">
                </div>
                <div class="input-group">
                    <label for="activitySubject" class="block text-sm font-medium text-gray-700">Тема занятия</label>
                    <input type="text" id="activitySubject" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Например: Производные">
                </div>
                <div class="input-group">
                    <label for="activityNotes" class="block text-sm font-medium text-gray-700">Заметка</label>
                    <textarea id="activityNotes" rows="3" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm" placeholder="Дополнительная информация..."></textarea>
                </div>
                <div class="input-group">
                    <label for="documentFile" class="block text-sm font-medium text-gray-700">Прикрепить документ (только .txt)</label>
                    <input type="file" id="documentFile" accept=".txt" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                </div>
                <div class="flex flex-col sm:flex-row space-y-4 sm:space-y-0 sm:space-x-4 mt-4">
                    <button id="addActivityBtn" class="flex-1 justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">Добавить запись</button>
                    <button id="cancelFormBtn" class="flex-1 justify-center py-2 px-4 border border-transparent shadow-sm text-sm font-medium rounded-md text-white bg-gray-500 hover:bg-gray-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-400">Отмена</button>
                </div>
                <div id="formMessage" class="hidden mt-4 text-sm font-medium text-center p-2 rounded-md"></div>
            </div>
            
            <!-- Отображение списка занятий для выбранного дня -->
            <div id="activitiesList" class="space-y-4">
                <h2 class="text-xl font-bold text-gray-800 mb-4">Записи за <span id="selectedDateDisplay"></span></h2>
            </div>
        </div>
    </div>

    <!-- Firebase SDK Scripts -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, addDoc, deleteDoc, onSnapshot, collection, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyDqZQWrwnMrRRFin1X5RD87W3lkU8SZFmc",
          authDomain: "testapp-dbf60.firebaseapp.com",
          databaseURL: "https://testapp-dbf60-default-rtdb.firebaseio.com",
          projectId: "testapp-dbf60",
          storageBucket: "testapp-dbf60.firebasestorage.app",
          messagingSenderId: "387287061720",
          appId: "1:387287061720:web:5e189308c302ad4a44f3ad"
        };
        const appId = firebaseConfig.appId;

        // Initialize Firebase
        let app;
        let db;
        let userId = 'admin_user_id';
        let activitiesCollectionRef;

        // Auth UI Elements
        const authSection = document.getElementById('authSection');
        const passwordResetSection = document.getElementById('passwordResetSection');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const authBtn = document.getElementById('authBtn');
        const forgotPasswordLink = document.getElementById('forgotPasswordLink');
        const backToLoginLink = document.getElementById('backToLoginLink');
        const authMessage = document.getElementById('authMessage');

        // Main App UI Elements
        const mainAppSection = document.getElementById('mainAppSection');
        const signOutBtn = document.getElementById('signOutBtn');
        const calendarSection = document.getElementById('calendarSection');
        const activityFormSection = document.getElementById('activityFormSection');
        const calendarDaysContainer = document.getElementById('calendarDays');
        const currentMonthYear = document.getElementById('currentMonthYear');
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');
        const selectedDateInput = document.getElementById('selectedDateInput');
        const selectedDateDisplay = document.getElementById('selectedDateDisplay');
        const formTitle = document.getElementById('formTitle');
        const editingDocIdInput = document.getElementById('editingDocId');
        const returnToCalendarBtn = document.getElementById('returnToCalendarBtn');
        const formMessage = document.getElementById('formMessage');


        const activityTimeInput = document.getElementById('activityTime');
        const activityDisciplineInput = document.getElementById('activityDiscipline');
        const activitySubjectInput = document.getElementById('activitySubject');
        const activityNotesInput = document.getElementById('activityNotes');
        const documentFileInput = document.getElementById('documentFile');
        const addActivityBtn = document.getElementById('addActivityBtn');
        const cancelFormBtn = document.getElementById('cancelFormBtn');
        const activitiesList = document.getElementById('activitiesList');


        // Calendar state
        let currentDate = new Date();
        let allActivities = [];
        let selectedDayElement = null;
        
        const showAuthMessage = (message, isError = true) => {
            authMessage.textContent = message;
            authMessage.classList.remove('hidden');
            if (isError) {
                authMessage.classList.remove('bg-green-100', 'text-green-700');
                authMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                authMessage.classList.remove('bg-red-100', 'text-red-700');
                authMessage.classList.add('bg-green-100', 'text-green-700');
            }
        };

        const clearAuthMessage = () => {
            authMessage.textContent = '';
            authMessage.classList.add('hidden');
        };

        const showFormMessage = (message, isError = true) => {
            formMessage.textContent = message;
            formMessage.classList.remove('hidden');
            if (isError) {
                formMessage.classList.remove('bg-green-100', 'text-green-700');
                formMessage.classList.add('bg-red-100', 'text-red-700');
            } else {
                formMessage.classList.remove('bg-red-100', 'text-red-700');
                formMessage.classList.add('bg-green-100', 'text-green-700');
            }
        };

        const clearFormMessage = () => {
            formMessage.textContent = '';
            formMessage.classList.add('hidden');
        };
        
        const clearForm = () => {
            activityTimeInput.value = '';
            activityDisciplineInput.value = '';
            activitySubjectInput.value = '';
            activityNotesInput.value = '';
            documentFileInput.value = '';
            editingDocIdInput.value = '';
            addActivityBtn.textContent = 'Добавить запись';
            formTitle.textContent = 'Добавить запись';
            clearFormMessage();
        };

        const monthNames = ["Январь", "Февраль", "Март", "Апрель", "Май", "Июнь", "Июль", "Август", "Сентябрь", "Октябрь", "Ноябрь", "Декабрь"];

        // Function to render the calendar
        const renderCalendar = (date) => {
            const year = date.getFullYear();
            const month = date.getMonth();
            const firstDayOfMonth = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            currentMonthYear.textContent = `${monthNames[month]} ${year}`;
            calendarDaysContainer.innerHTML = '';

            const dayOfWeekOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; // Adjusting for Monday as the first day of the week

            for (let i = 0; i < dayOfWeekOffset; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('day', 'other-month');
                calendarDaysContainer.appendChild(emptyDay);
            }

            for (let day = 1; day <= daysInMonth; day++) {
                const dayElement = document.createElement('div');
                dayElement.classList.add('day');
                dayElement.textContent = day;
                
                const formattedDate = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                dayElement.setAttribute('data-date', formattedDate);
                
                const activitiesForDay = allActivities.filter(activity => activity.date === formattedDate);
                if (activitiesForDay.length > 0) {
                    dayElement.classList.add('has-activity');
                    dayElement.innerHTML += `<div class="day-info">${activitiesForDay.length} запись</div>`;
                }

                dayElement.addEventListener('click', () => {
                    if (selectedDayElement) {
                        selectedDayElement.classList.remove('selected');
                    }
                    selectedDayElement = dayElement;
                    dayElement.classList.add('selected');

                    selectedDateInput.value = formattedDate;
                    selectedDateDisplay.textContent = new Date(formattedDate + 'T00:00:00').toLocaleDateString('ru-RU', { year: 'numeric', month: 'long', day: 'numeric' });

                    showActivitiesForDate(formattedDate);
                    calendarSection.classList.add('hidden');
                    activityFormSection.classList.remove('hidden');
                    clearForm();
                });
                
                calendarDaysContainer.appendChild(dayElement);
            }
        };
        
        // Filter and display activities for a specific date
        const showActivitiesForDate = (date) => {
            const activitiesForDay = allActivities.filter(activity => activity.date === date);
            activitiesList.innerHTML = '';
            if (activitiesForDay.length === 0) {
                activitiesList.innerHTML = '<p class="text-center text-gray-500">Записей на эту дату нет. Добавьте первую!</p>';
            } else {
                activitiesForDay.forEach(activity => {
                    const activityItem = document.createElement('div');
                    activityItem.className = 'activity-item';
                    activityItem.setAttribute('data-id', activity.id);
                    
                    const time = activity.time || 'Нет времени';
                    const subject = activity.subject ? `<p class="text-sm text-gray-600 mt-1">Тема: ${activity.subject}</p>` : '';
                    const notes = activity.notes ? `<p class="text-sm text-gray-600 mt-1">Заметка: ${activity.notes}</p>` : '';
                    
                    let documentSection = '';
                    if (activity.documentContent) {
                        documentSection = `
                            <div class="mt-2 p-2 border border-gray-300 rounded-md bg-gray-100 text-sm">
                                <h4 class="font-bold mb-1">Файл: ${activity.documentName}</h4>
                                <button class="file-link expand-file" data-id="${activity.id}">Развернуть</button>
                                <pre class="whitespace-pre-wrap mt-2 hidden" id="file-content-${activity.id}">${activity.documentContent}</pre>
                                <button class="file-link download-file" data-id="${activity.id}" data-filename="${activity.documentName}">Скачать</button>
                            </div>`;
                    } else {
                        documentSection = `<span class="text-xs text-gray-500 mt-1">Нет документа</span>`;
                    }
                    
                    activityItem.innerHTML = `
                        <div>
                            <p class="font-medium text-lg text-gray-900">${activity.discipline}</p>
                            ${subject}
                            <p class="text-sm text-gray-600">Время: ${time}</p>
                            ${notes}
                            ${documentSection}
                        </div>
                        <button class="delete-btn" data-id="${activity.id}">Удалить</button>
                    `;
                    activitiesList.appendChild(activityItem);
                });
            }
        };

        // Initialize Firebase on window load
        window.onload = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    showAuthMessage("Ошибка: Firebase не инициализирован. Пожалуйста, предоставьте конфигурацию Firebase.");
                    console.error("Firebase config is empty.");
                    return;
                }
                
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);

                activitiesCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/activities`);

                authSection.classList.remove('hidden');
                mainAppSection.classList.add('hidden');
            } catch (error) {
                console.error("Error initializing Firebase:", error);
                showAuthMessage("Произошла ошибка при инициализации приложения. Пожалуйста, попробуйте снова.");
            }
        };

        // Handle hardcoded login
        authBtn.addEventListener('click', () => {
            const login = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if (login === 'admin' && password === 'admin') {
                authSection.classList.add('hidden');
                mainAppSection.classList.remove('hidden');
                setupRealtimeListener();
                renderCalendar(currentDate);
            } else {
                showAuthMessage("Неверный логин или пароль.");
            }
        });

        // Toggle to password reset section (now a hint)
        forgotPasswordLink.addEventListener('click', (e) => {
            e.preventDefault();
            authSection.classList.add('hidden');
            passwordResetSection.classList.remove('hidden');
        });

        // Toggle back to login from password reset
        backToLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            passwordResetSection.classList.add('hidden');
            authSection.classList.remove('hidden');
        });

        // Handle simple sign out
        signOutBtn.addEventListener('click', () => {
            mainAppSection.classList.add('hidden');
            authSection.classList.remove('hidden');
            emailInput.value = '';
            passwordInput.value = '';
        });

        // Setup real-time listener for the activities collection
        const setupRealtimeListener = () => {
            onSnapshot(activitiesCollectionRef, (snapshot) => {
                allActivities = [];
                snapshot.forEach(doc => {
                    allActivities.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderCalendar(currentDate);
                if (!activityFormSection.classList.contains('hidden')) {
                    showActivitiesForDate(selectedDateInput.value);
                }
            }, (error) => {
                console.error("Error fetching activities:", error);
                showFormMessage("Ошибка при загрузке занятий. Попробуйте обновить страницу.");
            });
        };

        // Calendar navigation
        prevMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() - 1);
            renderCalendar(currentDate);
        });
        nextMonthBtn.addEventListener('click', () => {
            currentDate.setMonth(currentDate.getMonth() + 1);
            renderCalendar(currentDate);
        });
        
        // Handle form cancellation
        cancelFormBtn.addEventListener('click', () => {
            activityFormSection.classList.add('hidden');
            calendarSection.classList.remove('hidden');
            clearForm();
        });
        
        // Event listener for adding/updating a new activity
        addActivityBtn.addEventListener('click', async () => {
            const date = selectedDateInput.value;
            const discipline = activityDisciplineInput.value.trim();
            const subject = activitySubjectInput.value.trim();
            const time = activityTimeInput.value;
            const notes = activityNotesInput.value.trim();
            const file = documentFileInput.files[0];
            const editingId = editingDocIdInput.value;

            if (!discipline) {
                showFormMessage("Пожалуйста, введите название дисциплины.");
                return;
            }

            try {
                let documentContent = null;
                if (file) {
                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        documentContent = event.target.result;
                        const activityData = {
                            discipline: discipline,
                            subject: subject || null,
                            date: date,
                            time: time || null,
                            notes: notes || null,
                            documentName: file.name,
                            documentContent: documentContent
                        };
                        if (editingId) {
                            await updateDoc(doc(db, activitiesCollectionRef.path, editingId), activityData);
                        } else {
                            await addDoc(activitiesCollectionRef, activityData);
                        }
                        // После успешного добавления, переходим к календарю
                        activityFormSection.classList.add('hidden');
                        calendarSection.classList.remove('hidden');
                        clearForm();
                    };
                    reader.readAsText(file); // Reads the file as text
                } else {
                    const activityData = {
                        discipline: discipline,
                        subject: subject || null,
                        date: date,
                        time: time || null,
                        notes: notes || null,
                        documentName: null,
                        documentContent: null
                    };
                    if (editingId) {
                        await updateDoc(doc(db, activitiesCollectionRef.path, editingId), activityData);
                    } else {
                        await addDoc(activitiesCollectionRef, activityData);
                    }
                    // После успешного добавления, переходим к календарю
                    activityFormSection.classList.add('hidden');
                    calendarSection.classList.remove('hidden');
                    clearForm();
                }
            } catch (e) {
                console.error("Error adding/updating document: ", e);
                showFormMessage("Произошла ошибка при добавлении/обновлении занятия. " + e.message);
            }
        });

        // Event listener for editing and deleting an activity
        activitiesList.addEventListener('click', async (e) => {
            // Handle edit click
            if (e.target.closest('.activity-item') && !e.target.classList.contains('delete-btn')) {
                const docId = e.target.closest('.activity-item').getAttribute('data-id');
                const activity = allActivities.find(a => a.id === docId);
                if (activity) {
                    editingDocIdInput.value = activity.id;
                    activityTimeInput.value = activity.time || '';
                    activityDisciplineInput.value = activity.discipline || '';
                    activitySubjectInput.value = activity.subject || '';
                    activityNotesInput.value = activity.notes || '';
                    addActivityBtn.textContent = 'Сохранить изменения';
                    formTitle.textContent = 'Редактировать запись';
                }
            }
            // Handle expand/collapse file content
            if (e.target.classList.contains('expand-file')) {
                const docId = e.target.getAttribute('data-id');
                const fileContentPre = document.getElementById(`file-content-${docId}`);
                if (fileContentPre.classList.contains('hidden')) {
                    fileContentPre.classList.remove('hidden');
                    e.target.textContent = 'Свернуть';
                } else {
                    fileContentPre.classList.add('hidden');
                    e.target.textContent = 'Развернуть';
                }
            }

            // Handle download click
            if (e.target.classList.contains('download-file')) {
                const docId = e.target.getAttribute('data-id');
                const activity = allActivities.find(a => a.id === docId);
                if (activity && activity.documentContent) {
                    const blob = new Blob([activity.documentContent], { type: 'text/plain' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = activity.documentName || 'document.txt';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                }
            }

            // Handle delete click
            if (e.target.classList.contains('delete-btn')) {
                const docId = e.target.getAttribute('data-id');
                try {
                    await deleteDoc(doc(db, activitiesCollectionRef.path, docId));
                } catch (e) {
                    console.error("Error removing document:", e);
                    showFormMessage("Произошла ошибка при удалении занятия.");
                }
            }
        });
        
        // Handle return to calendar button click
        cancelFormBtn.addEventListener('click', () => {
            activityFormSection.classList.add('hidden');
            calendarSection.classList.remove('hidden');
            clearForm();
        });

    </script>
</body>
</html>
